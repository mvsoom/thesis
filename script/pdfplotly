#!/usr/bin/env bash
set -e

usage() {
cat <<EOF
pdfplotly — export Plotly figure from notebook to PDF

Usage:
  pdfplotly NOTEBOOK.ipynb FIGINDEX OUT.pdf [WIDTH HEIGHT]

WIDTH/HEIGHT are in pixels (optional).
EOF
}

[ "$#" -lt 3 ] && usage && exit 1

nb="$1"
fig="$2"
out="$3"
width="${4:-}"
height="${5:-}"

tmp=$(mktemp)
trap 'rm -f "$tmp"' EXIT

# extract full figure json
jq -c --argjson k "$fig" '
[
  .cells[].outputs[]?
  | .data["application/vnd.plotly.v1+json"]?
  | select(.data | length > 0)
][ $k ]
' "$nb" > "$tmp"

python - "$tmp" "$out" "$width" "$height" <<'PY'
import sys
import plotly.io as pio
import plotly.graph_objects as go

pio.defaults.mathjax = (
    "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js"
    "?config=TeX-MML-AM_SVG"
)

json_path, out, width, height = sys.argv[1:]

fig = pio.from_json(open(json_path).read())

# =========================
# GOD SCIENCE TEMPLATE — tuned
# =========================

axis_common = dict(
    showline=True,
    mirror="allticks",
    linecolor="#000000",
    linewidth=1.4,

    ticks="inside",
    tickwidth=1.2,

    showgrid=True,
    gridcolor="rgba(0,0,0,0.19)",
    gridwidth=1,
    griddash="dot",

    zeroline=False,

    tickfont=dict(size=15),
    title_font=dict(size=17),

    title_standoff=10,

    minor=dict(
        ticks="inside",
        ticklen=4,
        showgrid=True,
        gridcolor="rgba(0,0,0,0.07)",
        griddash="dot",
    ),
)

template = go.layout.Template(

    layout=dict(
        plot_bgcolor="white",
        paper_bgcolor="white",

        colorway=[
            "#636EFA",
            "#EF553B",
            "#00CC96",
            "#AB63FA",
            "#FFA15A",
            "#19D3F3",
            "#FF6692",
            "#B6E880",
            "#FF97FF",
            "#FECB52",
        ],

        font=dict(
            family="Libertinus Serif",
            size=15,   # slightly larger global base
            color="#111111",
        ),

        margin=dict(l=60, r=90, t=55, b=65),

        title=dict(
            x=0.03,
            xanchor="left",
            font=dict(size=20),
        ),

        legend=dict(
            x=1.04,
            y=1,
            xanchor="left",
            yanchor="top",

            bgcolor="rgba(0,0,0,0)",
            borderwidth=0,

            font=dict(size=13.5),

            itemsizing="trace",   # better alignment
        ),

        xaxis=axis_common,
        yaxis=axis_common,
    ),

    data=dict(

        scatter=[
            go.Scatter(
                line=dict(width=1.8),
                marker=dict(size=5),
            )
        ],

        scattergl=[
            go.Scattergl(
                line=dict(width=1.8),
                marker=dict(size=5),
            )
        ],

        histogram=[
            go.Histogram(
                opacity=0.5,
                marker=dict(line=dict(width=0)),
            )
        ],
    )
)

pio.templates["god_science"] = template

fig.update_layout(template="god_science")

# =========================

kwargs = {}
if width:
    kwargs["width"] = int(width)
if height:
    kwargs["height"] = int(height)

fig.write_image(out, **kwargs)
PY